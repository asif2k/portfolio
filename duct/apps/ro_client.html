<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="utf-8" />
  <title>finally</title>
  <script src="../finally.js"></script>
  <script src="http://localhost:8081/api/ro"></script>

</head>

<body>
  <script>    
      fin.entry(function (fin, ge, math) {
          dependencies([
              ['ecs', '/libs/ecs.js'],
              ['math', '/libs/math.js'],
              ['ge', '/ge/index.js'],

          ]);

          var app = new ge.app({
              renderer: {
                  pixel_ratio: 1
              }
          });

         



          window.onresize = function () {
              app.render_system.resize();
          }
          function RD(a) {
              return a * math.DEGTORAD;
          }
          app.create_renderable(new ge.shading.light({
              intensity: 2,
              ambient: [1, 1, 1]
          }),
              function (m, e) {
                  e.ge_transform.rotate_eular(RD(-125), RD(160), 0);


                  m.enable_shadows({
                      shadow_intensity: 0.2,
                      shadow_map_size: 2048,
                      shadow_camera_distance: 25
                  })
              });

          var camera = app.render_system.camera;
          app.create_renderable(new ge.geometry.mesh({
              geometry: ge.geometry.shapes.plane({ width: 100, height: 100 }), material: new ge.shading.shaded_material({ specular: [0, 0, 0] })
          }),
              function (m, e) {
                  e.ge_transform.set_position(0, 0, 0).rotate_eular(RD(-90), 0, 0);
                  m.material.texture = ge.webgl.texture.from_url("res/r10.jpg", true);
                  math.mat3.translate_rotate_scale(m.material.texture_matrix, 0, 0, 16, 16, 0);


              });
          app.attach_component(camera, 'ge_mouse_camera_controller', {
              element: app.render_system.renderer.canvas,
              wheel_delta: 0.01,
              on_mouse_down: function (x, y, e) {
                  app.render_system.picking_mouse_x = x;
                  app.render_system.picking_mouse_y = y;
              },
              on_mouse_up: function (x, y, e) {
                  camera.ge_camera.is_locked = false;
              },
          });

          camera.ge_transform_controller.set_position(9.219439506530762, 12.407609939575195, 14.522102355957031)
              .set_rotate(-0.2650001347064972, 0.015000144951045513, 0);
          var cli = new ro.client("http://localhost:8081", "user1", "user1");


          var play_game = function (player) {
              cli.begin_updates(200);



              app.create_renderable(new ge.geometry.mesh({
                  geometry: ge.geometry.shapes.cube({ size: 1, depth:2, divs: 8 }),
                  material: new ge.shading.shaded_material({
                      wireframe: false,
                      ambient: [0, 0.2, 0.8],
                      cast_shadows: true

                  })
              }),
                  function (m, e) {
                      m.flags += ge.DISPLAY_ALWAYS;                     
                      m.material.complete_render_mesh = (function (sup) {
                          var v1 = math.vec4(), oi, ob;
                          var q1 = math.quat();
                          return function (renderer, shader, mesh) {

                              for (oi in cli.objects) {
                                  ob = cli.objects[oi];
                                  if (!ob.__local_object) {
                                      if (!ob.m4) {
                                          ob.m4 = math.mat4();
                                      }
                                      if (ro.interpolate_object(ob, 32)) {
                                          math.quat.rotate_eular(q1, ob.rot[0], ob.rot[1], ob.rot[2]);
                                          math.mat4.from_quat(ob.m4, q1);
                                          ob.m4[12] = ob.pos[0];
                                          ob.m4[13] = ob.pos[1];
                                          ob.m4[14] = ob.pos[2];

                                      }

                                      shader.set_uniform("u_model_rw", ob.m4);
                                      sup.apply(this, [renderer, shader, mesh]);
                                  }
                                 

                              }
                              
                          }
                      })(m.material.complete_render_mesh);



                  });


              app.start(function () {
                  if (camera.ge_transform.require_update !== 0) {
                      player.pos[0] = camera.ge_transform.position[0];
                      player.pos[1] = camera.ge_transform.position[1];
                      player.pos[2] = camera.ge_transform.position[2];

                      player.rot[0] = camera.ge_transform_controller.rotate[0];
                      player.rot[1] = camera.ge_transform_controller.rotate[1];
                      player.rot[2] = camera.ge_transform_controller.rotate[2];

                      cli.update_object(player);
                  }
              }, 1 / 12);










          }




          cli.login(function () {
              cli.api("get_controller_schemas", {controller:"admin" }, function (res) {                  
                  cli.set_schemas(JSON.parse(res.schemas));
                  


                  cli.connect("/connect/admin/3d1", function (ws) {
                      console.log(cli);

                      var player = cli.create_object("player");

                      play_game(player);

                  });




              });

          });



          

      });
    
  </script>


  
</body>
</html>